<!DOCTYPE html>
<html>
<head>
    <title>Shopify Product Sync</title>
    <style>
        body {
            background: #0a0a0a;
            color: #fff;
            font-family: -apple-system, system-ui, sans-serif;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            background: linear-gradient(to right, #60a5fa, #a78bfa);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #a0a0a0;
            font-size: 14px;
        }
        input {
            width: 100%;
            padding: 12px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            color: #fff;
            font-size: 16px;
        }
        input:focus {
            outline: none;
            border-color: #60a5fa;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin-right: 10px;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            display: none;
        }
        .status.success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            color: #10b981;
            display: block;
        }
        .status.error {
            background: rgba(244, 63, 94, 0.2);
            border: 1px solid #f43f5e;
            color: #f43f5e;
            display: block;
        }
        .status.info {
            background: rgba(96, 165, 250, 0.2);
            border: 1px solid #60a5fa;
            color: #60a5fa;
            display: block;
        }
        .products-list {
            margin-top: 30px;
            max-height: 400px;
            overflow-y: auto;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 20px;
        }
        .product-item {
            padding: 10px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .product-item:last-child {
            border-bottom: none;
        }
        .help-text {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 30px;
            font-size: 14px;
            color: #888;
        }
        .help-text strong {
            color: #60a5fa;
        }
        pre {
            background: #0a0a0a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üõçÔ∏è Shopify Product Sync</h1>
    
    <div class="help-text">
        <strong>Instructions:</strong><br>
        1. Enter your Shopify store domain (e.g., <code>your-store.myshopify.com</code>)<br>
        2. Enter your Shopify Admin API access token<br>
        3. Click "Test Connection" to verify credentials<br>
        4. Click "Sync Products" to import products to database<br>
        <br>
        <strong>Note:</strong> Your credentials will be saved to the database for future syncs.
    </div>
    
    <div class="form-group">
        <label for="storeDomain">Shopify Store Domain</label>
        <input type="text" id="storeDomain" placeholder="your-store.myshopify.com" />
    </div>
    
    <div class="form-group">
        <label for="accessToken">Access Token</label>
        <input type="password" id="accessToken" placeholder="shpat_xxxxxxxxxxxxx" />
    </div>
    
    <div>
        <button onclick="testConnection()">üîå Test Connection</button>
        <button onclick="syncProducts(false)">üì¶ Sync Products (Preview)</button>
        <button onclick="syncProducts(true)">üíæ Sync & Save to Database</button>
        <button onclick="viewCurrentProducts()">üëÅÔ∏è View Database Products</button>
    </div>
    
    <div id="status" class="status"></div>
    
    <div id="productsList" class="products-list" style="display: none;">
        <h3>Products:</h3>
        <div id="productsContent"></div>
    </div>
    
    <script>
        // Load saved credentials if any
        window.onload = async () => {
            try {
                const response = await fetch('http://localhost:3001/api/settings');
                const settings = await response.json();
                
                if (settings.shopify_store_domain) {
                    document.getElementById('storeDomain').value = settings.shopify_store_domain;
                }
                if (settings.shopify_access_token) {
                    document.getElementById('accessToken').value = settings.shopify_access_token;
                }
            } catch (error) {
                console.log('No saved credentials found');
            }
        };
        
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.innerHTML = message;
        }
        
        async function testConnection() {
            const storeDomain = document.getElementById('storeDomain').value;
            const accessToken = document.getElementById('accessToken').value;
            
            if (!storeDomain || !accessToken) {
                showStatus('Please enter both store domain and access token', 'error');
                return;
            }
            
            try {
                showStatus('Testing connection...', 'info');
                
                const response = await fetch('http://localhost:3001/api/shopify/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ storeDomain, accessToken })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showStatus(`‚úÖ Connection successful!<br>
                        Shop: ${result.shop.name}<br>
                        Email: ${result.shop.email}<br>
                        Plan: ${result.shop.plan_name}`, 'success');
                } else {
                    showStatus(`‚ùå Connection failed: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function syncProducts(saveToDb = false) {
            const storeDomain = document.getElementById('storeDomain').value;
            const accessToken = document.getElementById('accessToken').value;
            
            if (!storeDomain || !accessToken) {
                showStatus('Please enter both store domain and access token', 'error');
                return;
            }
            
            try {
                showStatus('Syncing products...', 'info');
                
                const response = await fetch('http://localhost:3001/api/shopify/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ storeDomain, accessToken, saveToDb })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const actionText = saveToDb ? 'saved to database' : 'retrieved (preview mode)';
                    showStatus(`‚úÖ Successfully ${actionText} ${result.count} products!`, 'success');
                    
                    // Display products
                    displayProducts(result.products);
                    
                    if (saveToDb && result.syncLog) {
                        console.log('Sync log:', result.syncLog);
                    }
                } else {
                    showStatus(`‚ùå Sync failed: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function viewCurrentProducts() {
            try {
                showStatus('Loading products from database...', 'info');
                
                const response = await fetch('http://localhost:3001/api/products');
                const products = await response.json();
                
                if (products.length > 0) {
                    showStatus(`Found ${products.length} products in database`, 'success');
                    displayProducts(products);
                } else {
                    showStatus('No products found in database. Please sync from Shopify first.', 'info');
                }
            } catch (error) {
                showStatus(`‚ùå Error loading products: ${error.message}`, 'error');
            }
        }
        
        function displayProducts(products) {
            const listDiv = document.getElementById('productsList');
            const contentDiv = document.getElementById('productsContent');
            
            if (!products || products.length === 0) {
                contentDiv.innerHTML = '<p>No products found</p>';
            } else {
                contentDiv.innerHTML = products.map(product => `
                    <div class="product-item">
                        <div>
                            <strong>${product.title}</strong><br>
                            <small>ID: ${product.id || product.shopify_id} | SKU: ${product.sku || 'N/A'}</small>
                        </div>
                        <div>
                            $${product.price || '0.00'}
                        </div>
                    </div>
                `).join('');
            }
            
            listDiv.style.display = 'block';
        }
    </script>
</body>
</html>